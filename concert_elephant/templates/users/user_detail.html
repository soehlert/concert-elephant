{% extends "base.html" %}

{% load static %}
{% load crispy_forms_filters %}
{% load custom_filters %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col col-md-12 col-sm-12">
      <div class="card">
        <h5 class="card-header card-header-custom display-4 text-center">My Concerts</h5>
      </div>
      {% if object == request.user %}
        <table class="table table-striped">
          <tr>
            <th class="col-2">Artist</th>
            <th class="col-2 text-center">Venue</th>
            <th class="col-2 text-center">Date</th>
            <th class="col-3 text-center">Openers</th>
            <th class="col-3">Review</th>
          </tr>
          {% for concert in concerts_with_reviews %}
            <tr data-concert-details-url="{% url 'concerts:concert-detail' concert.id %}">
              <td>{{ concert.artist }}</td>
              <td class="text-center">{{ concert.venue }}</td>
              <td class="text-center">{{ concert.date }}</td>
              <td>
                {% for opener in concert.opener.all %}
                  {{ opener.name }}{% if not forloop.last %},{% endif %}
                {% endfor %}
              </td>
              <td>
                 {% if concert.user_review %}
                    <strong>Rating:</strong> {{ concert.user_review.rating }}/5
                    <p class="review-note">
                        {% if concert.user_review.note|length > 150 %}
                            <span class="truncated-note">
                                {{ concert.user_review.note|slice:":150" }}...
                                <i class="bi bi-arrow-bar-down show-more-btn"
                                   style="cursor:pointer"
                                   title="Show more"
                                   onclick="toggleReview(this)"></i>
                            </span>
                            <span class="full-note" style="display:none;">
                                {{ concert.user_review.note }}
                                <i class="bi bi-arrow-bar-up show-less-btn"
                                   style="cursor:pointer"
                                   title="Show less"
                                   onclick="toggleReview(this)"></i>
                            </span>
                            <br />
                            <i class="bi bi-pencil-square edit-review-btn"
                               style="cursor:pointer"
                               title="Edit review"
                               data-review-id="{{ concert.user_review.id }}"
                               data-concert-id="{{ concert.id }}"
                               data-review-details-url="{% url 'concerts:get-concert-review' concert.user_review.id %}">
                            </i>
                        {% else %}
                            {{ concert.user_review.note }}
                            <br />
                            <i class="bi bi-pencil-square edit-review-btn"
                               style="cursor:pointer"
                               title="Edit review"
                               data-review-id="{{ concert.user_review.id }}"
                               data-concert-id="{{ concert.id }}"
                               data-review-details-url="{% url 'concerts:get-concert-review' concert.user_review.id %}">
                            </i>
                        {% endif %}
                    </p>
                {% else %}
                    <button class="btn btn-primary text-white showModalBtn"
                            data-concert-id="{{ concert.id }}">Add Review</button>
                {% endif %}
            </td>
            </tr>
          {% endfor %}
        </table>
      {% endif %}

      <!-- Pagination -->
      {% if concerts_with_reviews.has_other_pages %}
        <div class="pagination justify-content-center mb-2">
          <span class="step-links">
            {% if concerts_with_reviews.has_previous %}
              <a href="?page=1" class="btn btn-outline-primary text-white">&laquo; first</a>
              <a href="?page={{ concerts_with_reviews.previous_page_number }}"
                 class="btn btn-outline-primary text-white">previous</a>
            {% endif %}
            {# Display up to 2 pages before the current page #}
            {% for page_number in concerts_with_reviews.paginator.page_range %}
              {% if page_number >= concerts_with_reviews.number|subtract:2 and page_number <= concerts_with_reviews.number|add:2 %}
                {% if concerts_with_reviews.number == page_number %}
                  <button class="btn btn-outline-primary active text-white">
                    <span class="current-page">{{ concerts_with_reviews.number }}</span>
                  </button>
                {% else %}
                  <a href="?page={{ page_number }}"
                     class="btn btn-outline-primary text-white">{{ page_number }}</a>
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if concerts_with_reviews.has_next %}
              <a href="?page={{ concerts_with_reviews.next_page_number }}"
                 class="btn btn-outline-primary text-white">next</a>
              <a href="?page={{ concerts_with_reviews.paginator.num_pages }}"
                 class="btn btn-outline-primary text-white">last &raquo;</a>
            {% endif %}
          </span>
        </div>
      {% endif %}
    </div>

    <!-- Bootstrap Modal for Writing a Concert Review -->
    <div class="modal fade"
         id="createReviewModal"
         tabindex="-1"
         role="dialog"
         data-add-review="{% url 'concerts:add-concert-review' 0%}"
         data-update-review="{% url 'concerts:update-concert-review' 0 %}"
         data-action-type="add"
         aria-labelledby="createReviewModalLabel"
         aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createReviewModalLabel">Review the Concert</h5>
            <button type="button"
                    id="closeReviewModalButton"
                    class="btn btn-info text-white close"
                    data-dismiss="modal"
                    aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="modal-messages" id="modal-review-messages"></div>
            <form method="post" id="reviewForm">
              {% csrf_token %}
              <input type="hidden" name="review_id" id="reviewId" value="" />
              <h5 id="modalTitle">{{ concert }}</h5>
              <div class="form-group">
                <label for="reviewText">Review</label>
                <textarea class="form-control"
                          name="note"
                          id="reviewText"
                          rows="3"
                          placeholder="Write your review..."></textarea>
              </div>
              <div class="form-group">
                <label for="starRating">Rating</label>
                <select class="form-control" name="rating" id="starRating">
                  <option>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                  <option>5</option>
                </select>
              </div>
              <div class="d-flex mt-2">
                  <button type="submit" id="concert-review-submit" class="btn btn-primary text-white mx-auto"
                      data-add-review-url-template="{% url 'concerts:add-concert-review' 0 %}">Submit Review</button>
                      <i id="deleteReviewIcon" title="Delete review" data-review-id="{{ concert.user_review.id }}"
                         data-delete-review-url="{% url 'concerts:delete-concert-review' 0 %}"
                         class="bi bi-trash text-danger align-self-center" style="cursor:pointer; display:none"></i>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap modal for confirming the deletion of concert review -->
    <div class="modal fade"
         id="confirmDeleteModal"
         tabindex="-1"
         aria-labelledby="confirmDeleteModalLabel"
         aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"></button>
          </div>
          <div class="modal-body">Are you sure you want to delete this review?</div>
          <div class="modal-footer">
            <button type="button"
                    class="btn btn-secondary text-white"
                    data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger text-white"
                    id="confirmDeleteBtn">Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="{% static 'js/user_detail.js' %}"></script>
{% endblock content %}
